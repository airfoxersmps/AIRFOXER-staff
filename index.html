<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirFoxer Staff Portal - Check-in</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #f97316;
            --secondary: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-dark: #0f172a;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            
            --checked-in: #22c55e;
            --checked-out: #94a3b8;
            --not-checked: #f59e0b;
        }

        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
        }

        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-warning { background: var(--warning); }
        .toast-info { background: var(--info); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary);
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .logo-text p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .staff-badge {
            background: var(--primary);
            color: white;
            padding: 8px 20px;
            border-radius: 40px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 20px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            min-width: 200px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.total { background: #dbeafe; color: var(--secondary); }
        .stat-icon.verified { background: #d1fae5; color: var(--success); }
        .stat-icon.checked { background: #fef3c7; color: var(--warning); }

        .stat-info h3 {
            font-size: 28px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-info p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 16px;
            min-width: 200px;
        }

        .search-box input:focus {
            outline: none;
        }

        .search-box select {
            padding: 8px 15px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
        }

        #searchResults {
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: none;
        }

        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: var(--bg-secondary);
        }

        .quick-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-stat-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .quick-stat-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .quick-stat-value {
            font-size: 32px;
            font-weight: 800;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .scanner-section, .team-info-section {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-header h2 {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .camera-selector {
            display: flex;
            gap: 10px;
        }

        .camera-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .camera-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .scanner-container {
            padding: 20px;
        }

        #qr-reader {
            width: 100%;
            min-height: 300px;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .scan-status {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--warning);
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background: var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .no-team-selected {
            padding: 60px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .no-team-selected i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .team-card {
            padding: 30px;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .team-name {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .team-org {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .team-status-badge {
            padding: 8px 20px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-checked-in {
            background: #d1fae5;
            color: #065f46;
        }

        .status-not-checked {
            background: #fef3c7;
            color: #92400e;
        }

        .team-theme {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .theme-label {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .theme-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .member-verification {
            margin: 15px 0;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .member-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .member-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .member-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
        }

        .member-role {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .member-name {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .member-email {
            font-size: 11px;
            color: var(--text-light);
        }

        .team-notes-section {
            margin: 15px 0;
        }

        .notes-input-group {
            display: flex;
            gap: 10px;
        }

        .notes-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .notes-display {
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-style: italic;
        }

        .checkin-history {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .history-title {
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .history-item.in {
            border-left: 4px solid var(--success);
        }

        .history-item.out {
            border-left: 4px solid var(--warning);
        }

        .history-action {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .history-time {
            font-size: 12px;
            color: var(--text-light);
        }

        .checkin-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .btn-checkin {
            background: var(--success);
            color: white;
        }

        .btn-checkout {
            background: var(--warning);
            color: white;
        }

        .btn-checkin:hover:not(:disabled),
        .btn-checkout:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .undo-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .undo-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .quick-actions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
            justify-content: center;
            pointer-events: none;
        }

        .quick-action-btn {
            pointer-events: auto;
            flex: 0 1 auto;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: 700;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .scan-history-section {
            grid-column: span 2;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .scan-history-list {
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .scan-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .scan-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .scan-icon.success { background: #d1fae5; color: var(--success); }
        .scan-icon.error { background: #fee2e2; color: var(--danger); }
        .scan-icon.warning { background: #fef3c7; color: var(--warning); }

        .scan-details {
            flex: 1;
        }

        .scan-team {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .scan-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-light);
        }

        .scan-time {
            color: var(--text-light);
            font-size: 12px;
        }

        .manual-entry {
            margin: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px dashed var(--border);
        }

        .manual-title {
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .manual-input-group {
            display: flex;
            gap: 10px;
        }

        .manual-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .manual-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-manual {
            padding: 12px 24px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .offline-badge {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--warning);
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: 600;
            z-index: 1001;
            display: none;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .scan-history-section {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-bar {
                flex-direction: column;
            }
            
            .team-header {
                flex-direction: column;
            }
            
            .checkin-actions {
                flex-direction: column;
            }
            
            .quick-stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="offline-badge" class="offline-badge">
        <i class="fas fa-wifi-slash"></i> Offline Mode
    </div>

    <div id="loading-screen" class="loading-screen">
        <div class="spinner"></div>
        <p style="color: var(--text-secondary);">Initializing Staff Portal...</p>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <div id="app-container" class="app-container" style="display: none;">
        <div class="header">
            <div class="logo-area">
                <div class="logo-icon">
                    <i class="fas fa-qrcode"></i>
                </div>
                <div class="logo-text">
                    <h1>AirFoxer Staff Portal</h1>
                    <p>Team Check-in System</p>
                </div>
            </div>
            <div class="staff-badge">
                <i class="fas fa-id-badge"></i>
                <span>STAFF ACCESS</span>
            </div>
            <div class="header-actions">
                <div class="theme-toggle" onclick="toggleTheme()">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-icon total">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3 id="total-teams">0</h3>
                    <p>Total Teams</p>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-icon verified">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="verified-teams">0</h3>
                    <p>Verified Teams</p>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-icon checked">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="stat-info">
                    <h3 id="checked-teams">0</h3>
                    <p>Checked In</p>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-box">
                <i class="fas fa-search" style="color: var(--text-light);"></i>
                <input type="text" id="searchTeams" placeholder="Search by Team Name, ID, Member Name, Email..." onkeyup="searchTeams()">
                <select id="statusFilter" onchange="searchTeams()">
                    <option value="all">All Teams</option>
                    <option value="checkedin">Checked In</option>
                    <option value="notcheckedin">Not Checked In</option>
                    <option value="verified">Verified</option>
                    <option value="unverified">Unverified</option>
                </select>
            </div>
            <div id="searchResults"></div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats-grid" id="quickStats"></div>

        <div class="main-grid">
            <div class="scanner-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-camera" style="color: var(--primary);"></i>
                        QR Scanner
                    </h2>
                    <div class="camera-selector">
                        <button class="camera-btn" onclick="switchToBackCamera()" id="cam-back" title="Back Camera">
                            <i class="fas fa-mobile-alt"></i>
                        </button>
                        <button class="camera-btn" onclick="switchToFrontCamera()" id="cam-front" title="Front Camera">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                </div>
                <div class="scanner-container">
                    <div id="qr-reader"></div>
                    <div class="scan-status">
                        <span class="status-indicator" id="scanner-status"></span>
                        <span id="scanner-status-text">Click 'Start Scanning' to begin</span>
                    </div>
                    <button onclick="startScanner()" class="btn btn-checkin" style="margin-top: 15px; padding: 12px;">
                        <i class="fas fa-play"></i> Start Scanner
                    </button>
                    <button onclick="stopScanner()" class="btn btn-checkout" style="margin-top: 15px; padding: 12px;">
                        <i class="fas fa-stop"></i> Stop Scanner
                    </button>
                </div>

                <div class="manual-entry">
                    <div class="manual-title">
                        <i class="fas fa-keyboard" style="color: var(--secondary);"></i>
                        Manual Entry
                    </div>
                    <div class="manual-input-group">
                        <input type="text" class="manual-input" id="manual-team-id" placeholder="Enter Team ID or Name">
                        <button class="btn-manual" onclick="lookupTeam()">
                            <i class="fas fa-search"></i> Find
                        </button>
                    </div>
                </div>
            </div>

            <div class="team-info-section" id="team-info-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                        Team Information
                    </h2>
                </div>
                <div id="team-info-content">
                    <div class="no-team-selected">
                        <i class="fas fa-qrcode"></i>
                        <h3>No Team Selected</h3>
                        <p>Scan a QR code or enter Team ID to view team details</p>
                    </div>
                </div>
            </div>

            <div class="scan-history-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-history" style="color: var(--success);"></i>
                        Recent Activity
                    </h2>
                    <button class="camera-btn" onclick="clearHistory()" title="Clear History">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="scan-history-list" id="scan-history-list">
                    <div style="text-align: center; color: var(--text-light); padding: 20px;">
                        No activity yet. Scan a QR code to begin.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Undo Container -->
    <div id="undoContainer"></div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn" onclick="showCheckinSummary()">
            <i class="fas fa-chart-bar"></i> Summary
        </button>
        <button class="quick-action-btn" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCipUkkNySML4U1VI2fH1RyWgXYqvDMPRQ",
            authDomain: "airfoxer-hackathon.firebaseapp.com",
            projectId: "airfoxer-hackathon",
            storageBucket: "airfoxer-hackathon.firebasestorage.app",
            messagingSenderId: "51363230854",
            appId: "1:51363230854:web:4a33c8a92ebebb41b5cd07"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized");
            db = firebase.firestore();
        } catch (error) {
            console.error("Firebase init error:", error);
        }

        const COLLECTIONS = {
            TEAMS: 'teams',
            CHECKINS: 'checkins'
        };

        let currentTeam = null;
        let teams = [];
        let checkins = [];
        let scanHistory = [];
        let html5QrcodeScanner = null;
        let lastAction = null;
        let pendingActions = [];

        // Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
            }

            await loadData();
            
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            }, 1000);

            setupRealtimeUpdates();
            setupOfflineSupport();
            checkStaleCheckins();
            setInterval(checkStaleCheckins, 30 * 60 * 1000); // Check every 30 minutes
        });

        async function loadData() {
            try {
                const teamsSnap = await db.collection(COLLECTIONS.TEAMS).get();
                teams = teamsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const checkinsSnap = await db.collection(COLLECTIONS.CHECKINS)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                checkins = checkinsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                updateStats();
                updateQuickStats();
                console.log("Data loaded:", teams.length, "teams,", checkins.length, "check-ins");
            } catch (error) {
                console.error("Error loading data:", error);
                showToast("Failed to load data", "error");
            }
        }

        function setupRealtimeUpdates() {
            db.collection(COLLECTIONS.TEAMS).onSnapshot((snapshot) => {
                teams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateStats();
                updateQuickStats();
                if (currentTeam) {
                    const updatedTeam = teams.find(t => t.id === currentTeam.id);
                    if (updatedTeam) {
                        currentTeam = updatedTeam;
                        displayTeamInfo(currentTeam);
                    }
                }
            });

            db.collection(COLLECTIONS.CHECKINS)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    checkins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentTeam) {
                        displayTeamInfo(currentTeam);
                    }
                });
        }

        function setupOfflineSupport() {
            // Check online status
            window.addEventListener('online', syncOfflineActions);
            window.addEventListener('offline', () => {
                document.getElementById('offline-badge').style.display = 'flex';
                showToast("You are offline - changes will be saved locally", "warning");
            });

            // Load pending actions
            const saved = localStorage.getItem('pendingCheckins');
            if (saved) {
                pendingActions = JSON.parse(saved);
            }
        }

        async function syncOfflineActions() {
            document.getElementById('offline-badge').style.display = 'none';
            
            if (pendingActions.length > 0) {
                showToast(`Syncing ${pendingActions.length} offline actions...`, "info");
                
                for (const action of pendingActions) {
                    try {
                        await processCheckin(action);
                    } catch (error) {
                        console.error("Sync error:", error);
                    }
                }
                
                pendingActions = [];
                localStorage.removeItem('pendingCheckins');
                showToast(`✅ Synced all offline actions`, "success");
            }
        }

        async function processCheckin(action) {
            // Process the check-in action
            if (action.type === 'checkin') {
                await db.collection(COLLECTIONS.CHECKINS).add({
                    teamId: action.teamId,
                    teamName: action.teamName,
                    action: 'in',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    checkedBy: 'Staff',
                    date: new Date().toISOString().split('T')[0]
                });
                
                await db.collection(COLLECTIONS.TEAMS).doc(action.teamId).update({
                    checkedIn: true,
                    lastCheckin: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        function updateStats() {
            const verifiedTeams = teams.filter(t => t.status === 'verified' && t.paymentStatus === 'verified');
            const checkedIn = teams.filter(t => t.checkedIn === true);
            
            document.getElementById('total-teams').textContent = teams.length;
            document.getElementById('verified-teams').textContent = verifiedTeams.length;
            document.getElementById('checked-teams').textContent = checkedIn.length;
        }

        function updateQuickStats() {
            const verified = teams.filter(t => t.paymentStatus === 'verified').length;
            const checked = teams.filter(t => t.checkedIn).length;
            const notChecked = verified - checked;
            const unverified = teams.length - verified;
            
            const html = `
                <div class="quick-stat-card">
                    <div class="quick-stat-label">Verified Teams</div>
                    <div class="quick-stat-value" style="color: var(--success);">${verified}</div>
                </div>
                <div class="quick-stat-card">
                    <div class="quick-stat-label">Ready to Check-in</div>
                    <div class="quick-stat-value" style="color: var(--warning);">${notChecked}</div>
                </div>
                <div class="quick-stat-card">
                    <div class="quick-stat-label">Unverified</div>
                    <div class="quick-stat-value" style="color: var(--danger);">${unverified}</div>
                </div>
                <div class="quick-stat-card">
                    <div class="quick-stat-label">Checked In</div>
                    <div class="quick-stat-value" style="color: var(--primary);">${checked}</div>
                </div>
            `;
            
            document.getElementById('quickStats').innerHTML = html;
        }

        // Search function
        function searchTeams() {
            const searchTerm = document.getElementById('searchTeams').value.toLowerCase();
            const filter = document.getElementById('statusFilter').value;
            
            if (!searchTerm && filter === 'all') {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            let filtered = teams;
            
            // Apply filter
            if (filter === 'checkedin') {
                filtered = filtered.filter(t => t.checkedIn);
            } else if (filter === 'notcheckedin') {
                filtered = filtered.filter(t => !t.checkedIn);
            } else if (filter === 'verified') {
                filtered = filtered.filter(t => t.paymentStatus === 'verified');
            } else if (filter === 'unverified') {
                filtered = filtered.filter(t => t.paymentStatus !== 'verified');
            }
            
            // Apply search
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    (t.teamName && t.teamName.toLowerCase().includes(searchTerm)) ||
                    (t.id && t.id.toLowerCase().includes(searchTerm)) ||
                    (t.members && t.members.some(m => 
                        (m.name && m.name.toLowerCase().includes(searchTerm)) ||
                        (m.email && m.email.toLowerCase().includes(searchTerm))
                    ))
                );
            }
            
            if (filtered.length === 0) {
                document.getElementById('searchResults').innerHTML = '<div style="padding: 20px; text-align: center;">No teams found</div>';
                document.getElementById('searchResults').style.display = 'block';
                return;
            }
            
            const resultsHtml = filtered.slice(0, 10).map(team => `
                <div class="search-result-item" onclick="selectTeam('${team.id}')">
                    <div>
                        <strong>${team.teamName || 'Unnamed'}</strong>
                        <div style="font-size: 12px; color: var(--text-light);">Members: ${team.members?.length || 0}</div>
                    </div>
                    <div>
                        <span style="padding: 4px 8px; border-radius: 4px; background: ${team.checkedIn ? 'var(--success)' : 'var(--warning)'}; color: white; font-size: 12px;">
                            ${team.checkedIn ? 'Checked In' : 'Not Checked'}
                        </span>
                        ${team.paymentStatus === 'verified' ? 
                            '<span style="margin-left: 5px; color: var(--success);"><i class="fas fa-check-circle"></i></span>' : 
                            '<span style="margin-left: 5px; color: var(--danger);"><i class="fas fa-times-circle"></i></span>'}
                    </div>
                </div>
            `).join('');
            
            if (filtered.length > 10) {
                resultsHtml += `<div style="padding: 10px; text-align: center; color: var(--text-light);">... and ${filtered.length - 10} more</div>`;
            }
            
            document.getElementById('searchResults').innerHTML = resultsHtml;
            document.getElementById('searchResults').style.display = 'block';
        }

        function selectTeam(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (team) {
                displayTeamInfo(team);
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('searchTeams').value = '';
            }
        }

        // ============================================
        // QR SCANNER
        // ============================================
        function startScanner() {
            const qrReaderElement = document.getElementById('qr-reader');
            qrReaderElement.innerHTML = '';
            
            document.getElementById('scanner-status-text').textContent = 'Requesting camera access...';
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showToast("Your browser doesn't support camera access", "error");
                document.getElementById('scanner-status-text').textContent = 'Camera not supported';
                return;
            }

            try {
                html5QrcodeScanner = new Html5Qrcode("qr-reader");
                
                const cameraConfig = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };

                html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    cameraConfig,
                    onScanSuccess,
                    onScanError
                ).then(() => {
                    document.getElementById('scanner-status').classList.add('active');
                    document.getElementById('scanner-status-text').textContent = 'Scanner active - point at QR code';
                    showToast("Scanner started successfully", "success");
                }).catch((err) => {
                    console.error("Camera start error:", err);
                    document.getElementById('scanner-status-text').textContent = 'Failed to start camera';
                    showToast("Camera error: " + err.message, "error");
                });

            } catch (error) {
                console.error("Scanner initialization error:", error);
                document.getElementById('scanner-status-text').textContent = 'Scanner initialization failed';
                showToast("Failed to initialize scanner", "error");
            }
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('scanner-status').classList.remove('active');
                    document.getElementById('scanner-status-text').textContent = 'Scanner stopped';
                    showToast("Scanner stopped", "info");
                }).catch((err) => {
                    console.error("Error stopping scanner:", err);
                });
            }
        }

        function switchToBackCamera() {
            stopScanner();
            setTimeout(() => {
                if (html5QrcodeScanner) {
                    const cameraConfig = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    };
                    
                    html5QrcodeScanner.start(
                        { facingMode: "environment" },
                        cameraConfig,
                        onScanSuccess,
                        onScanError
                    ).then(() => {
                        document.getElementById('scanner-status').classList.add('active');
                        document.getElementById('scanner-status-text').textContent = 'Back camera active';
                        document.querySelectorAll('.camera-btn').forEach(btn => btn.classList.remove('active'));
                        document.getElementById('cam-back').classList.add('active');
                    });
                }
            }, 500);
        }

        function switchToFrontCamera() {
            stopScanner();
            setTimeout(() => {
                if (html5QrcodeScanner) {
                    const cameraConfig = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    };
                    
                    html5QrcodeScanner.start(
                        { facingMode: "user" },
                        cameraConfig,
                        onScanSuccess,
                        onScanError
                    ).then(() => {
                        document.getElementById('scanner-status').classList.add('active');
                        document.getElementById('scanner-status-text').textContent = 'Front camera active';
                        document.querySelectorAll('.camera-btn').forEach(btn => btn.classList.remove('active'));
                        document.getElementById('cam-front').classList.add('active');
                    });
                }
            }, 500);
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log("QR Code scanned:", decodedText);
            
            if (navigator.vibrate) navigator.vibrate(200);
            
            try {
                let teamId;
                try {
                    const qrData = JSON.parse(decodedText);
                    teamId = qrData.t || qrData.teamId || qrData.id;
                } catch (e) {
                    teamId = decodedText;
                }
                
                if (!teamId) {
                    showToast("Invalid QR code", "error");
                    addToHistory("Unknown", 'error', 'Invalid format');
                    return;
                }
                
                let team = teams.find(t => t.id === teamId);
                if (!team) team = teams.find(t => t.id.startsWith(teamId));
                
                if (!team) {
                    showToast("Team not found", "error");
                    addToHistory(teamId.substring(0, 10) + '...', 'error', 'Not found');
                    return;
                }
                
                addToHistory(team.teamName, 'success', 'Scanned');
                displayTeamInfo(team);
                
            } catch (error) {
                console.error("Error processing QR:", error);
                showToast("Error processing QR", "error");
            }
        }

        function onScanError(error) {
            if (error.includes('NotFound')) {
                document.getElementById('scanner-status-text').textContent = 'No camera found';
            }
        }

        // ============================================
        // VERIFICATION FUNCTION (MOST IMPORTANT)
        // ============================================
        function verifyTeamBeforeCheckin(team) {
            if (!team) return false;
            
            if (team.paymentStatus !== 'verified') {
                showToast(`❌ ${team.teamName} - PAYMENT NOT VERIFIED!`, "error");
                return false;
            }
            
            if (team.status !== 'verified') {
                showToast(`❌ ${team.teamName} - REGISTRATION NOT VERIFIED!`, "error");
                return false;
            }
            
            if (!team.members || team.members.length < 2) {
                showToast(`❌ ${team.teamName} - NEED AT LEAST 2 MEMBERS! (Current: ${team.members?.length || 0})`, "error");
                return false;
            }
            
            return true;
        }

        // ============================================
        // CHECK-IN FUNCTIONS
        // ============================================
        async function checkInTeam(teamId) {
            if (!teamId || !currentTeam) return;
            
            // VERIFY FIRST!
            if (!verifyTeamBeforeCheckin(currentTeam)) {
                return;
            }
            
            // Double confirmation
            if (!confirm(`Check in ${currentTeam.teamName}?\nMembers: ${currentTeam.members?.length || 0}\nVerified: ✅`)) {
                return;
            }
            
            // Store last action for undo
            lastAction = {
                type: 'checkin',
                teamId: teamId,
                teamName: currentTeam.teamName,
                timestamp: new Date()
            };
            
            // Show undo button
            showUndoButton();
            
            try {
                // Check if offline
                if (!navigator.onLine) {
                    pendingActions.push({
                        type: 'checkin',
                        teamId: teamId,
                        teamName: currentTeam.teamName,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('pendingCheckins', JSON.stringify(pendingActions));
                    showToast(`📱 Saved offline - ${currentTeam.teamName} will be checked in when online`, "warning");
                    
                    // Update local state
                    currentTeam.checkedIn = true;
                    displayTeamInfo(currentTeam);
                    addToHistory(currentTeam.teamName, 'success', 'Checked in (offline)');
                    return;
                }
                
                // Online check-in
                await db.collection(COLLECTIONS.CHECKINS).add({
                    teamId: teamId,
                    teamName: currentTeam.teamName,
                    action: 'in',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    checkedBy: 'Staff',
                    date: new Date().toISOString().split('T')[0]
                });
                
                await db.collection(COLLECTIONS.TEAMS).doc(teamId).update({
                    checkedIn: true,
                    lastCheckin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`✅ ${currentTeam.teamName} checked in successfully`, "success");
                addToHistory(currentTeam.teamName, 'success', 'Checked in');
                
            } catch (error) {
                console.error("Check-in error:", error);
                showToast("Failed to check in", "error");
            }
        }

        async function checkOutTeam(teamId) {
            if (!teamId || !currentTeam) return;
            
            if (!confirm(`Check out ${currentTeam.teamName}?`)) {
                return;
            }
            
            // Store last action for undo
            lastAction = {
                type: 'checkout',
                teamId: teamId,
                teamName: currentTeam.teamName,
                timestamp: new Date()
            };
            
            showUndoButton();
            
            try {
                if (!navigator.onLine) {
                    pendingActions.push({
                        type: 'checkout',
                        teamId: teamId,
                        teamName: currentTeam.teamName,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('pendingCheckins', JSON.stringify(pendingActions));
                    showToast(`📱 Saved offline - ${currentTeam.teamName} will be checked out when online`, "warning");
                    
                    currentTeam.checkedIn = false;
                    displayTeamInfo(currentTeam);
                    addToHistory(currentTeam.teamName, 'success', 'Checked out (offline)');
                    return;
                }
                
                await db.collection(COLLECTIONS.CHECKINS).add({
                    teamId: teamId,
                    teamName: currentTeam.teamName,
                    action: 'out',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    checkedBy: 'Staff',
                    date: new Date().toISOString().split('T')[0]
                });
                
                await db.collection(COLLECTIONS.TEAMS).doc(teamId).update({
                    checkedIn: false,
                    lastCheckout: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`✅ ${currentTeam.teamName} checked out`, "success");
                addToHistory(currentTeam.teamName, 'success', 'Checked out');
                
            } catch (error) {
                console.error("Check-out error:", error);
                showToast("Failed to check out", "error");
            }
        }

        function showUndoButton() {
            const undoHtml = `
                <div class="undo-button">
                    <span>✅ Last: ${lastAction.teamName} (${lastAction.type})</span>
                    <button class="undo-btn" onclick="undoLastAction()">↩️ Undo</button>
                </div>
            `;
            document.getElementById('undoContainer').innerHTML = undoHtml;
            
            // Auto hide after 10 seconds
            setTimeout(() => {
                document.getElementById('undoContainer').innerHTML = '';
            }, 10000);
        }

        async function undoLastAction() {
            if (!lastAction) return;
            
            try {
                if (lastAction.type === 'checkin') {
                    // Undo check-in by checking out
                    await db.collection(COLLECTIONS.CHECKINS).add({
                        teamId: lastAction.teamId,
                        teamName: lastAction.teamName,
                        action: 'out',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        checkedBy: 'Staff (Undo)',
                        date: new Date().toISOString().split('T')[0],
                        note: 'Undo last action'
                    });
                    
                    await db.collection(COLLECTIONS.TEAMS).doc(lastAction.teamId).update({
                        checkedIn: false
                    });
                    
                    showToast(`↩️ Undid check-in for ${lastAction.teamName}`, "success");
                } else {
                    // Undo check-out by checking in
                    await db.collection(COLLECTIONS.CHECKINS).add({
                        teamId: lastAction.teamId,
                        teamName: lastAction.teamName,
                        action: 'in',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        checkedBy: 'Staff (Undo)',
                        date: new Date().toISOString().split('T')[0],
                        note: 'Undo last action'
                    });
                    
                    await db.collection(COLLECTIONS.TEAMS).doc(lastAction.teamId).update({
                        checkedIn: true
                    });
                    
                    showToast(`↩️ Undid check-out for ${lastAction.teamName}`, "success");
                }
                
                document.getElementById('undoContainer').innerHTML = '';
                lastAction = null;
                
            } catch (error) {
                console.error("Undo error:", error);
                showToast("Failed to undo", "error");
            }
        }

        // Check for stale check-ins
        function checkStaleCheckins() {
            const checkedInTeams = teams.filter(t => t.checkedIn);
            const now = new Date();
            
            checkedInTeams.forEach(team => {
                if (team.lastCheckin) {
                    const checkinTime = team.lastCheckin.toDate?.() || new Date(team.lastCheckin);
                    const hoursCheckedIn = (now - checkinTime) / (1000 * 60 * 60);
                    
                    if (hoursCheckedIn > 4) {
                        showToast(`⚠️ ${team.teamName} checked in for ${Math.floor(hoursCheckedIn)} hours`, "warning");
                    }
                }
            });
        }

        // ============================================
        // TEAM DISPLAY
        // ============================================
        function displayTeamInfo(team) {
            currentTeam = team;
            
            const teamCheckins = checkins
                .filter(c => c.teamId === team.id)
                .sort((a, b) => {
                    const timeA = a.timestamp?.toDate?.() || new Date(0);
                    const timeB = b.timestamp?.toDate?.() || new Date(0);
                    return timeB - timeA;
                });
            
            const isVerified = team.paymentStatus === 'verified' && team.status === 'verified';
            const hasMinMembers = team.members && team.members.length >= 2;
            
            const html = `
                <div class="team-card">
                    <div class="team-header">
                        <div>
                            <div class="team-name">${team.teamName || 'Unnamed Team'}</div>
                            <div class="team-org">${team.organization || 'No organization'}</div>
                            <div style="margin-top: 5px; font-size: 12px; color: var(--text-light);">ID: ${team.id.substring(0, 12)}...</div>
                        </div>
                        <div class="team-status-badge ${team.checkedIn ? 'status-checked-in' : 'status-not-checked'}">
                            <i class="fas fa-${team.checkedIn ? 'check-circle' : 'clock'}"></i>
                            ${team.checkedIn ? 'Checked In' : 'Not Checked In'}
                        </div>
                    </div>
                    
                    <div class="team-theme">
                        <div class="theme-label">HACKATHON THEME</div>
                        <div class="theme-value">${team.theme || 'Open Innovation'}</div>
                    </div>
                    
                    <!-- Verification Status -->
                    <div style="margin: 15px 0; padding: 15px; background: var(--bg-secondary); border-radius: 12px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div>
                                <span style="color: var(--text-light);">Payment:</span>
                                ${team.paymentStatus === 'verified' ? 
                                    '<span style="color: var(--success); margin-left: 5px;"><i class="fas fa-check-circle"></i> Verified</span>' : 
                                    '<span style="color: var(--danger); margin-left: 5px;"><i class="fas fa-times-circle"></i> Not Verified</span>'}
                            </div>
                            <div>
                                <span style="color: var(--text-light);">Registration:</span>
                                ${team.status === 'verified' ? 
                                    '<span style="color: var(--success); margin-left: 5px;"><i class="fas fa-check-circle"></i> Verified</span>' : 
                                    '<span style="color: var(--danger); margin-left: 5px;"><i class="fas fa-times-circle"></i> Not Verified</span>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Member Verification -->
                    <div class="member-verification">
                        <div class="member-status">
                            <span><i class="fas fa-users"></i> Team Members: <strong>${team.members?.length || 0}/4</strong></span>
                            ${hasMinMembers ? 
                                '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Minimum met (2+)</span>' : 
                                '<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Need at least 2 members</span>'}
                        </div>
                        <div class="member-list">
                            ${team.members && team.members.length > 0 ? team.members.map((member, index) => `
                                <div class="member-item">
                                    <i class="fas fa-user-circle" style="color: var(--primary);"></i>
                                    <div style="flex: 1;">
                                        <div><strong>${member.name || 'No name'}</strong> ${index === 0 ? '👑 Lead' : ''}</div>
                                        <div style="font-size: 11px; color: var(--text-light);">${member.email || ''}</div>
                                    </div>
                                </div>
                            `).join('') : '<div style="padding: 10px; text-align: center;">No members listed</div>'}
                        </div>
                    </div>
                    
                    <!-- Team Notes -->
                    <div class="team-notes-section">
                        <div class="notes-input-group">
                            <input type="text" class="notes-input" id="teamNote" placeholder="Add note about this team...">
                            <button onclick="addTeamNote('${team.id}')" class="btn-manual" style="padding: 10px 20px;">Save</button>
                        </div>
                        <div id="notes-${team.id}" class="notes-display">
                            ${team.notes ? `📝 ${team.notes}` : ''}
                        </div>
                    </div>
                    
                    <div class="checkin-history">
                        <div class="history-title">
                            <i class="fas fa-history"></i>
                            Check-in History
                        </div>
                        <div class="history-list">
                            ${teamCheckins.length > 0 ? teamCheckins.map(checkin => `
                                <div class="history-item ${checkin.action || 'in'}">
                                    <div class="history-action">
                                        <i class="fas fa-${checkin.action === 'out' ? 'sign-out-alt' : 'sign-in-alt'}"></i>
                                        ${checkin.action === 'out' ? 'Check Out' : 'Check In'}
                                    </div>
                                    <div class="history-time">${formatTime(checkin.timestamp)}</div>
                                </div>
                            `).join('') : 'No check-in history'}
                        </div>
                    </div>
                    
                    <div class="checkin-actions">
                        ${!team.checkedIn ? 
                            `<button class="btn btn-checkin" onclick="checkInTeam('${team.id}')" ${!isVerified || !hasMinMembers ? 'disabled' : ''}>
                                <i class="fas fa-sign-in-alt"></i> Check In Team
                            </button>` :
                            `<button class="btn btn-checkout" onclick="checkOutTeam('${team.id}')">
                                <i class="fas fa-sign-out-alt"></i> Check Out Team
                            </button>`
                        }
                    </div>
                    
                    ${!isVerified ? 
                        '<div style="margin-top: 10px; padding: 10px; background: var(--danger); color: white; border-radius: 8px; text-align: center;">⚠️ Cannot check in - Verification required</div>' : 
                        !hasMinMembers ? 
                        '<div style="margin-top: 10px; padding: 10px; background: var(--warning); color: white; border-radius: 8px; text-align: center;">⚠️ Cannot check in - Need at least 2 team members</div>' : 
                        ''}
                </div>
            `;
            
            document.getElementById('team-info-content').innerHTML = html;
        }

        async function addTeamNote(teamId) {
            const note = document.getElementById('teamNote').value.trim();
            if (!note) return;
            
            try {
                await db.collection(COLLECTIONS.TEAMS).doc(teamId).update({
                    notes: note,
                    lastNote: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast("Note saved", "success");
                document.getElementById('teamNote').value = '';
                
                if (currentTeam) {
                    currentTeam.notes = note;
                    displayTeamInfo(currentTeam);
                }
            } catch (error) {
                console.error("Error saving note:", error);
                showToast("Failed to save note", "error");
            }
        }

        // ============================================
        // MANUAL LOOKUP
        // ============================================
        function lookupTeam() {
            const input = document.getElementById('manual-team-id').value.trim().toLowerCase();
            
            if (!input) {
                showToast("Enter team ID or name", "warning");
                return;
            }
            
            const team = teams.find(t => 
                t.id.toLowerCase().includes(input) ||
                (t.teamName && t.teamName.toLowerCase().includes(input)) ||
                (t.teamCode && t.teamCode.toLowerCase().includes(input))
            );
            
            if (!team) {
                showToast("Team not found", "error");
                addToHistory(input, 'error', 'Not found');
                return;
            }
            
            displayTeamInfo(team);
            addToHistory(team.teamName, 'success', 'Manual lookup');
            document.getElementById('manual-team-id').value = '';
        }

        // ============================================
        // HISTORY FUNCTIONS
        // ============================================
        function addToHistory(teamName, type, action) {
            scanHistory.unshift({
                teamName: teamName,
                type: type,
                action: action,
                time: new Date().toLocaleTimeString()
            });
            
            if (scanHistory.length > 20) scanHistory.pop();
            updateHistory();
        }

        function updateHistory() {
            const list = document.getElementById('scan-history-list');
            
            if (scanHistory.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px;">No activity yet</div>';
                return;
            }
            
            list.innerHTML = scanHistory.map(item => `
                <div class="scan-item">
                    <div class="scan-icon ${item.type}">
                        <i class="fas fa-${item.type === 'success' ? 'check' : (item.type === 'warning' ? 'exclamation' : 'times')}"></i>
                    </div>
                    <div class="scan-details">
                        <div class="scan-team">${item.teamName}</div>
                        <div class="scan-meta">${item.action}</div>
                    </div>
                    <div class="scan-time">${item.time}</div>
                </div>
            `).join('');
        }

        function clearHistory() {
            scanHistory = [];
            updateHistory();
            showToast("History cleared", "info");
        }

        // ============================================
        // UTILITIES
        // ============================================
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleTimeString();
            } catch {
                return 'N/A';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : (type === 'error' ? 'exclamation-circle' : 'info-circle')}"></i><span>${message}</span>`;
            
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function refreshData() {
            loadData();
            showToast("Data refreshed", "success");
        }

        function showCheckinSummary() {
            const verified = teams.filter(t => t.paymentStatus === 'verified').length;
            const checked = teams.filter(t => t.checkedIn).length;
            const notChecked = verified - checked;
            
            showToast(`📊 Summary: ${checked} checked in, ${notChecked} ready, ${teams.length - verified} unverified`, "info");
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().catch(() => {});
            }
        });
    </script>
</body>
</html>